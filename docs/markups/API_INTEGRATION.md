# Архитектура системы наценок платформы

## Обзор системы

Система наценок платформы представляет собой гибкий механизм применения дополнительных сборов к различным типам транзакций. Система поддерживает полиморфные связи, приоритеты применения и расширенный аудит изменений.

## Ключевые компоненты

### Модели данных

#### PlatformMarkup
Основная модель наценок с полиморфными связями:

```php
PlatformMarkup {
    id
    platform_id
    markupable_type    // Полиморфный тип: Equipment, Category, Company, null
    markupable_id      // ID сущности
    entity_type        // Контекст: order, rental_request, proposal
    type              // Тип наценки: fixed, percent, tiered, combined, seasonal
    calculation_type  // Метод расчета: addition, multiplication, complex
    value             // Значение наценки
    priority          // Приоритет (0-999)
    rules             // Дополнительные правила (JSON)
    is_active         // Статус активности
    valid_from        // Начало действия
    valid_to          // Окончание действия
}
PlatformMarkupAudit
Система аудита всех изменений:

php
PlatformMarkupAudit {
    id
    platform_markup_id
    user_id
    action            // created, updated, deleted
    old_values        // JSON
    new_values        // JSON
    reason           // Причина изменения
}
Сервисы расчета
MarkupCalculationService
Универсальный сервис расчета наценок:

php
class MarkupCalculationService {
    public function calculateMarkup(
        float $basePrice,
        string $entityType,
        int $workingHours = 1,
        ?int $equipmentId = null,
        ?int $categoryId = null,
        ?int $companyId = null,
        ?int $lesseeCompanyId = null
    ): array
}
Интегрированные сервисы
PricingService - расчет цен для заказов

RentalRequestPricingService - ценообразование заявок

PublicPricingService - публичное ценообразование

Принципы работы
Приоритетная система
Наценки применяются по приоритету (от высшего к низшему):

Оборудование (300-399) - конкретная техника

Категория (200-299) - категория оборудования

Компания (100-199) - компания арендатора

Общая наценка (0-99) - системная наценка

Процесс расчета
Поиск наценки по контексту и приоритету

Валидация активности и периода действия

Применение правил в зависимости от типа наценки

Кэширование результата для производительности

Аудит операции расчета

Типы наценок
Фиксированная (fixed)
Добавляет фиксированную сумму за час работы

Пример: 100 ₽/час × 8 часов = 800 ₽

Процентная (percent)
Добавляет процент от базовой цены

Пример: 10% от 1000 ₽ = 100 ₽

Ступенчатая (tiered)
Разные значения в зависимости от объема/срока

Пример:

0-100 часов: 50 ₽/час

101-200 часов: 40 ₽/час

Комбинированная (combined)
Сочетание фиксированной и процентной частей

Пример: 50 ₽/час + 5% от цены

Сезонная (seasonal)
Коэффициенты в зависимости от сезона

Пример: высокий сезон ×1.5, низкий сезон ×0.7

Интеграция с системой
Контексты применения
Заказы (order)
Применяется к финальным заказам аренды

Учитывает рабочее время и условия аренды

Заявки на аренду (rental_request)
Расчет для предложений арендодателей

Обратное применение наценки

Предложения (proposal)
Ценообразование коммерческих предложений

Специальные условия для переговоров

API endpoints
text
GET    /admin/markups                    # Список наценок
POST   /admin/markups                    # Создание наценки
PUT    /admin/markups/{id}              # Обновление наценки
DELETE /admin/markups/{id}              # Удаление наценки
POST   /admin/markups/test-calculation  # Тестирование расчета
GET    /admin/markups/statistics        # Статистика
POST   /admin/markups/bulk-operations   # Массовые операции
Безопасность и доступ
Ролевая модель
Администраторы - полный доступ

Менеджеры - просмотр и ограниченное редактирование

Аналитики - только просмотр статистики

Валидация данных
Проверка бизнес-правил

Валидация периодов действия

Контроль приоритетов

Проверка уникальности

Производительность
Кэширование
Результаты расчета наценок

Списки активных наценок

Статистические данные

Индексация
sql
INDEX (priority, is_active)
INDEX (entity_type, priority)  
INDEX (markupable_type, markupable_id, priority)
INDEX (valid_from, valid_to)
Оптимизации
Пакетная обработка массовых операций

Фоновые задачи для тяжелых расчетов

Инкрементальное обновление статистики

Мониторинг и аналитика
Метрики
Количество применений наценок

Общий доход от наценок

Эффективность по типам и контекстам

Время выполнения расчетов

Аудит
Полная история изменений

Отслеживание пользовательских действий

Экспорт данных для анализа

Расширяемость
Добавление новых типов наценок
Регистрация типа в MarkupCalculationService

Добавление правил валидации

Создание UI компонентов

Обновление документации

Интеграция с внешними системами
Webhooks для уведомлений

REST API для управления

Экспорт данных в форматах CSV/JSON

text

Теперь создам руководство пользователя - `docs/markups/USER_GUIDE.md`:

```markdown
# Руководство администратора системы наценок

## Начало работы

### Доступ к системе
1. Войдите в админ-панель платформы
2. Перейдите в раздел "Наценки" в меню управления
3. Убедитесь, что у вас есть права доступа к управлению наценками

### Обзор интерфейса

Интерфейс системы состоит из нескольких разделов:

- **Список наценок** - просмотр и управление всеми наценками
- **Создание/редактирование** - форма настройки наценки
- **Тестирование** - интерактивный калькулятор
- **Статистика** - аналитика применения
- **Журнал аудита** - история изменений
- **Массовые операции** - групповое управление

## Создание наценки

### Основные настройки

#### Платформа
- Выберите платформу, для которой применяется наценка
- Обычно используется "Основная платформа"

#### Контекст применения
- **Заказы** - для финальных заказов аренды
- **Заявки на аренду** - для расчетов в заявках
- **Предложения** - для коммерческих предложений

#### Тип наценки
- **Фиксированная** - постоянная сумма за час
- **Процентная** - процент от базовой цены
- **Ступенчатая** - зависит от объема/срока
- **Комбинированная** - фиксированная + процентная
- **Сезонная** - коэффициенты по сезонам

### Область применения

#### Общая наценка
- Применяется ко всем операциям выбранного контекста
- Используется как наценка по умолчанию

#### Привязка к сущностям
- **Оборудование** - для конкретной техники
- **Категория** - для категории оборудования
- **Компания** - для компании арендатора

### Приоритет системы

Приоритет определяет порядок применения наценок:

- **0-99** - Общие наценки (низший приоритет)
- **100-199** - Наценки компаний
- **200-299** - Наценки категорий  
- **300-399** - Наценки оборудования (высший приоритет)

### Период действия

- **Действует с** - дата начала действия
- **Действует до** - дата окончания действия
- Оставьте пустыми для постоянного действия

## Типы наценок и их настройка

### Фиксированная наценка

**Настройка:**
- Значение: сумма в рублях за час работы
- Пример: `100` = 100 рублей за каждый час аренды

**Расчет:**
Наценка = Значение × Рабочие_часы

text

### Процентная наценка

**Настройка:**
- Значение: процент от базовой цены
- Пример: `10` = 10% от стоимости аренды

**Расчет:**
Наценка = Базовая_цена × (Значение / 100)

text

### Ступенчатая наценка

**Настройка:**
1. Укажите базовое значение (используется если не подходят ступени)
2. Добавьте ступени с условиями:
   - Мин. часы / Макс. часы
   - Тип значения (фиксированная/процентная)
   - Значение наценки

**Пример ступеней:**
0-100 часов: 50 ₽/час (фиксированная)
101-200 часов: 40 ₽/час (фиксированная)
201+ часов: 5% (процентная)

text

### Комбинированная наценка

**Настройка:**
- Фиксированная часть (₽/час)
- Процентная часть (%)
- Пример: `50 ₽ + 5%`

**Расчет:**
Наценка = (Фиксированная × Часы) + (Базовая_цена × Процентная / 100)

text

### Сезонная наценка

**Настройка:**
- Базовый процент наценки
- Коэффициенты для сезонов:
  - Высокий сезон (май-сентябрь)
  - Средний сезон (март-апрель, октябрь)
  - Низкий сезон (ноябрь-февраль)

**Расчет:**
Наценка = Базовая_цена × (Базовый_процент / 100) × Коэффициент_сезона

text

## Тестирование наценок

### Интерактивный тестер

Используйте встроенный тестер для проверки расчетов:

1. **Базовая цена** - стоимость аренды за час
2. **Рабочие часы** - продолжительность аренды
3. **Контекст** - тип операции (заказ/заявка/предложение)
4. **ID сущностей** - для тестирования привязанных наценок

### Пакетное тестирование

Запустите несколько тестов одновременно для сравнения:
- Разные базовые цены
- Разное количество часов
- Разные контексты применения

### История тестов

- Сохраняйте результаты для анализа
- Сравнивайте разные сценарии
- Экспортируйте данные для отчетов

## Массовые операции

### Быстрый выбор

Используйте предустановленные фильтры для выбора групп наценок:
- Все наценки
- Только активные
- Только неактивные
- Истекшие наценки
- Общие наценки

### Операции со статусом

- **Активировать** - сделать наценки активными
- **Деактивировать** - отключить наценки
- **Переключить** - инвертировать статус

### Изменение приоритета

Установите единый приоритет для выбранных наценок:
- Общие: 0-99
- Компании: 100-199  
- Категории: 200-299
- Оборудование: 300-399

### Обновление значений

**Типы обновлений:**
- Фиксированное значение
- Увеличить на процент
- Уменьшить на процент
- Умножить на коэффициент

**Фильтрация по типам:**
- Применяйте изменения только к определенным типам наценок

### Обновление периодов

**Опции:**
- Установить конкретные даты
- Продлить действие на указанное количество дней
- Очистить даты (сделать постоянными)

### Опасные операции

**Дублирование** - создание копий выбранных наценок
**Удаление** - безвозвратное удаление наценок
**Архивирование** - деактивация с сохранением истории

⚠️ **Внимание!** Опасные операции требуют подтверждения и не могут быть отменены.

## Мониторинг и аналитика

### Ключевые метрики

На главной странице статистики отображаются:
- **Всего применений** - количество использований наценок
- **Общий доход** - суммарный доход от наценок
- **Активных наценок** - количество активных правил
- **Средняя наценка** - среднее значение на применение

### Графики и отчеты

#### Динамика применения
- Тренды использования наценок по времени
- Сравнение доходов от разных типов наценок

#### Распределение по типам
- Круговые диаграммы использования типов наценок
- Эффективность разных подходов к ценообразованию

#### Топ наценок
- Список наиболее доходных наценок
- Показатели эффективности применения

### Детальный анализ

#### Производительность
- Время расчета наценок
- Распределение времени ответа
- Оптимизация быстродействия

#### Сезонность
- Анализ сезонных колебаний
- Эффективность сезонных наценок
- Рекомендации по коэффициентам

#### Сравнение периодов
- Изменения ключевых показателей
- Анализ эффективности изменений
- Выявление трендов

## Журнал аудита

### Просмотр истории

Фильтруйте записи по:
- **Действию** - создание, обновление, удаление
- **Пользователю** - кто совершил изменение
- **Наценке** - конкретная наценка
- **Периоду** - дата изменения

### Детали изменений

Для каждой записи доступно:
- Полная информация об изменении
- Сравнение старых и новых значений
- Причина изменения (если указана)
- Временная метка и пользователь

### Экспорт данных

Выгружайте данные аудита в форматах:
- **CSV** - для анализа в табличных редакторах
- **JSON** - для интеграции с другими системами

## Советы и лучшие практики

### Планирование наценок

1. **Начните с общих наценок** - установите базовые правила
2. **Добавляйте исключения** - для особых случаев используйте приоритеты
3. **Тестируйте изменения** - используйте тестер перед применением
4. **Мониторьте эффективность** - анализируйте статистику регулярно

### Управление приоритетами

- Используйте понятную систему нумерации
- Оставляйте зазоры между группами для будущих изменений
- Документируйте правила приоритетов

### Безопасность изменений

- Всегда указывайте причину изменений в массовых операциях
- Используйте режим предпросмотра перед применением
- Регулярно делайте резервные копии конфигураций

### Оптимизация производительности

- Избегайте избыточного количества активных наценок
- Используйте кэширование для часто применяемых правил
- Мониторьте время выполнения расчетов

## Устранение неисправностей

### Частые проблемы

**Наценка не применяется:**
- Проверьте статус активности
- Убедитесь, что период действия не истек
- Проверьте приоритет относительно других наценок

**Некорректный расчет:**
- Проверьте тип и значение наценки
- Убедитесь в правильности рабочих часов
- Протестируйте в калькуляторе

**Медленная работа:**
- Уменьшите количество активных наценок
- Проверьте индексацию в базе данных
- Используйте кэширование

### Получение помощи

При возникновении проблем:
1. Проверьте журнал аудита для анализа изменений
2. Используйте тестер для воспроизведения проблемы
3. Обратитесь к технической документации
4. Свяжитесь с технической поддержкой

## Обновления системы

Система наценок регулярно обновляется. Следите за:
- Новыми типами наценок
- Улучшениями интерфейса
- Оптимизациями производительности
- Расширением аналитических возможностей

Перед обновлением:
- Сделайте резервную копию конфигураций
- Протестируйте критический функционал
- Ознакомьтесь с изменениями в документации
Продолжим с API документацией или бизнес-правилами?

Да, продолжаем
Создаю API документацию - docs/markups/API_INTEGRATION.md:

markdown
# API интеграции системы наценок

## Обзор API

REST API системы наценок предоставляет полный доступ к управлению правилами наценок, расчетам и аналитике. Все endpoints требуют аутентификации и авторизации.

## Базовый URL
https://your-platform.com/api/v1/markups

text

## Аутентификация

### Bearer Token
```http
Authorization: Bearer {api_token}
Headers
http
Content-Type: application/json
Accept: application/json
X-Requested-With: XMLHttpRequest
Модели данных
PlatformMarkup
json
{
  "id": 1,
  "platform_id": 1,
  "markupable_type": "App\\Models\\Equipment",
  "markupable_id": 123,
  "entity_type": "order",
  "type": "percent",
  "calculation_type": "addition",
  "value": 10.5,
  "priority": 150,
  "rules": {
    "tiers": [
      {
        "min": 0,
        "max": 100,
        "type": "fixed",
        "value": 50
      }
    ]
  },
  "is_active": true,
  "valid_from": "2024-01-01",
  "valid_to": "2024-12-31",
  "created_at": "2024-01-15T10:30:00Z",
  "updated_at": "2024-01-15T10:30:00Z"
}
MarkupCalculationResult
json
{
  "success": true,
  "result": {
    "base_price": 1000.00,
    "markup_type": "percent",
    "markup_value": 10.5,
    "markup_amount": 105.00,
    "final_price": 1105.00,
    "working_hours": 8,
    "calculation_details": {
      "source": "equipment:123",
      "priority": 150,
      "rules": {},
      "calculation_type": "addition"
    }
  }
}
Endpoints
Управление наценками
Получить список наценок
http
GET /markups
Параметры запроса:

markupable_type - фильтр по типу сущности

entity_type - фильтр по контексту

type - фильтр по типу наценки

is_active - фильтр по статусу

page - номер страницы

per_page - элементов на странице

Пример ответа:

json
{
  "data": [
    {
      "id": 1,
      "platform_id": 1,
      "markupable_type": "App\\Models\\Equipment",
      "markupable_id": 123,
      "entity_type": "order",
      "type": "percent",
      "value": 10.5,
      "priority": 150,
      "is_active": true,
      "valid_from": "2024-01-01",
      "valid_to": "2024-12-31",
      "created_at": "2024-01-15T10:30:00Z"
    }
  ],
  "links": {
    "first": "/api/v1/markups?page=1",
    "last": "/api/v1/markups?page=10",
    "prev": null,
    "next": "/api/v1/markups?page=2"
  },
  "meta": {
    "current_page": 1,
    "from": 1,
    "last_page": 10,
    "path": "/api/v1/markups",
    "per_page": 25,
    "to": 25,
    "total": 250
  }
}
Создать наценку
http
POST /markups
Тело запроса:

json
{
  "platform_id": 1,
  "markupable_type": "App\\Models\\Equipment",
  "markupable_id": 123,
  "entity_type": "order",
  "type": "percent",
  "calculation_type": "addition",
  "value": 10.5,
  "priority": 150,
  "rules": {
    "tiers": [
      {
        "min": 0,
        "max": 100,
        "type": "fixed",
        "value": 50
      }
    ]
  },
  "is_active": true,
  "valid_from": "2024-01-01",
  "valid_to": "2024-12-31"
}
Пример ответа:

json
{
  "success": true,
  "data": {
    "id": 1,
    "platform_id": 1,
    "markupable_type": "App\\Models\\Equipment",
    "markupable_id": 123,
    "entity_type": "order",
    "type": "percent",
    "value": 10.5,
    "priority": 150,
    "is_active": true,
    "valid_from": "2024-01-01",
    "valid_to": "2024-12-31",
    "created_at": "2024-01-15T10:30:00Z",
    "updated_at": "2024-01-15T10:30:00Z"
  },
  "message": "Наценка успешно создана"
}
Получить наценку
http
GET /markups/{id}
Обновить наценку
http
PUT /markups/{id}
Тело запроса: аналогично созданию

Удалить наценку
http
DELETE /markups/{id}
Пример ответа:

json
{
  "success": true,
  "message": "Наценка успешно удалена"
}
Расчет наценок
Тестовый расчет
http
POST /markups/calculate
Тело запроса:

json
{
  "base_price": 1000.00,
  "entity_type": "order",
  "working_hours": 8,
  "equipment_id": 123,
  "category_id": 45,
  "company_id": 67,
  "lessee_company_id": 89
}
Пример ответа:

json
{
  "success": true,
  "result": {
    "base_price": 1000.00,
    "markup_type": "percent",
    "markup_value": 10.5,
    "markup_amount": 105.00,
    "final_price": 1105.00,
    "working_hours": 8,
    "calculation_details": {
      "source": "equipment:123",
      "priority": 150,
      "rules": {},
      "calculation_type": "addition"
    }
  }
}
Пакетный расчет
http
POST /markups/calculate-batch
Тело запроса:

json
{
  "calculations": [
    {
      "base_price": 1000.00,
      "entity_type": "order",
      "working_hours": 8,
      "equipment_id": 123
    },
    {
      "base_price": 1500.00,
      "entity_type": "rental_request",
      "working_hours": 24,
      "category_id": 45
    }
  ]
}
Пример ответа:

json
{
  "success": true,
  "results": [
    {
      "base_price": 1000.00,
      "markup_type": "percent",
      "markup_value": 10.5,
      "markup_amount": 105.00,
      "final_price": 1105.00,
      "working_hours": 8,
      "calculation_details": {
        "source": "equipment:123",
        "priority": 150
      }
    },
    {
      "base_price": 1500.00,
      "markup_type": "fixed",
      "markup_value": 100.00,
      "markup_amount": 100.00,
      "final_price": 1600.00,
      "working_hours": 24,
      "calculation_details": {
        "source": "category:45",
        "priority": 200
      }
    }
  ],
  "summary": {
    "total_calculations": 2,
    "successful_calculations": 2,
    "average_execution_time": 15.2
  }
}
Массовые операции
Выполнить массовые операции
http
POST /markups/bulk-operations
Тело запроса:

json
{
  "markup_ids": [1, 2, 3, 4, 5],
  "operations": [
    {
      "type": "status",
      "data": {
        "action": "activate"
      }
    },
    {
      "type": "priority",
      "data": {
        "priority": 150
      }
    }
  ],
  "preview": false,
  "send_notifications": true,
  "reason": "Массовая активация наценок"
}
Пример ответа:

json
{
  "success": true,
  "status": "completed",
  "processed": 5,
  "success": 5,
  "errors": 0,
  "message": "Массовые операции успешно выполнены",
  "details": [
    {
      "markup_id": 1,
      "status": "success",
      "message": "Статус обновлен",
      "execution_time": 12
    }
  ]
}
Статистика и аналитика
Получить общую статистику
http
GET /markups/statistics
Параметры запроса:

period - week, month, quarter, year, custom

date_from - начальная дата (для custom)

date_to - конечная дата (для custom)

group_by - day, week, month, quarter

Пример ответа:

json
{
  "success": true,
  "metrics": {
    "total_applications": 1250,
    "total_revenue": 125000.00,
    "active_markups": 45,
    "markup_types_count": 5,
    "avg_markup_value": 100.00,
    "application_change": 15.5,
    "revenue_change": 22.3
  },
  "top_markups": [
    {
      "id": 1,
      "type": "percent",
      "entity_type": "order",
      "value": 10.5,
      "applications": 450,
      "revenue": 47250.00,
      "efficiency": 85.5
    }
  ],
  "charts": {
    "applications": {
      "labels": ["2024-01-01", "2024-01-02", "2024-01-03"],
      "applications": [45, 52, 38],
      "revenue": [4500, 5200, 3800]
    }
  }
}
Получить статистику по наценке
http
GET /markups/{id}/statistics
Параметры запроса:

period - период анализа

date_from - начальная дата

date_to - конечная дата

Аудит и журналирование
Получить журнал аудита
http
GET /markups/audit-log
Параметры запроса:

action - created, updated, deleted

user_id - ID пользователя

platform_markup_id - ID наценки

date_from - начальная дата

date_to - конечная дата

search - поиск по причине/изменениям

Пример ответа:

json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "platform_markup_id": 1,
      "user_id": 1,
      "action": "updated",
      "old_values": {
        "value": 10.0,
        "is_active": true
      },
      "new_values": {
        "value": 10.5,
        "is_active": true
      },
      "reason": "Корректировка ставки",
      "created_at": "2024-01-15T10:30:00Z",
      "user": {
        "id": 1,
        "name": "Администратор",
        "email": "admin@example.com"
      },
      "markup": {
        "id": 1,
        "type": "percent",
        "entity_type": "order"
      },
      "formatted_changes": [
        {
          "field": "Значение",
          "from": "10.0",
          "to": "10.5"
        }
      ]
    }
  ]
}
Экспорт аудита
http
GET /markups/audit-export
Параметры запроса: аналогично журналу аудита
Response: файл CSV/JSON

Утилиты
Получить доступные сущности
http
GET /markups/available-entities
Пример ответа:

json
{
  "success": true,
  "equipment": [
    {
      "id": 1,
      "title": "Экскаватор CAT 320",
      "category_id": 5
    }
  ],
  "categories": [
    {
      "id": 5,
      "name": "Экскаваторы"
    }
  ],
  "companies": [
    {
      "id": 1,
      "legal_name": "ООО СтройТех",
      "is_lessee": true,
      "is_lessor": false
    }
  ]
}
Проверить здоровье системы
http
GET /markups/health
Пример ответа:

json
{
  "success": true,
  "status": "healthy",
  "timestamp": "2024-01-15T10:30:00Z",
  "metrics": {
    "active_markups": 45,
    "cache_hit_rate": 98.5,
    "average_response_time": 15.2,
    "error_rate": 0.1
  }
}
Коды ошибок
Общие ошибки
400 - Неверный запрос

401 - Не авторизован

403 - Доступ запрещен

404 - Ресурс не найден

422 - Ошибка валидации

429 - Слишком много запросов

500 - Внутренняя ошибка сервера

Бизнес-ошибки
MARKUP_001 - Наценка не найдена

MARKUP_002 - Конфликт приоритетов

MARKUP_003 - Недопустимый тип наценки

MARKUP_004 - Период действия невалиден

MARKUP_005 - Дублирующаяся наценка

Пример ошибки:

json
{
  "success": false,
  "error": {
    "code": "MARKUP_005",
    "message": "Наценка с такими параметрами уже существует",
    "details": {
      "platform_id": 1,
      "entity_type": "order",
      "markupable_type": "App\\Models\\Equipment",
      "markupable_id": 123
    }
  }
}
Rate Limiting
Лимиты запросов на endpoint:

Чтение: 1000 запросов в час

Запись: 100 запросов в час

Расчеты: 500 запросов в час

Массовые операции: 50 запросов в час

Headers ответа:

http
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 999
X-RateLimit-Reset: 1642230000
Webhooks
События
Система отправляет webhooks при следующих событиях:

markup.created - создана новая наценка

markup.updated - обновлена существующая наценка

markup.deleted - удалена наценка

markup.calculated - выполнен расчет наценки

bulk.operation.completed - завершены массовые операции

Конфигурация webhook
http
POST /webhooks
Тело запроса:

json
{
  "url": "https://your-service.com/webhooks/markups",
  "events": ["markup.created", "markup.updated"],
  "secret": "your_webhook_secret"
}
Payload webhook
json
{
  "event": "markup.created",
  "timestamp": "2024-01-15T10:30:00Z",
  "data": {
    "id": 1,
    "type": "percent",
    "entity_type": "order",
    "value": 10.5,
    "priority": 150,
    "is_active": true
  }
}
Примеры использования
Интеграция с системой заказов
javascript
// Расчет наценки для заказа
async function calculateOrderMarkup(orderData) {
  const response = await fetch('/api/v1/markups/calculate', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + apiToken,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      base_price: orderData.hourly_rate,
      entity_type: 'order',
      working_hours: orderData.duration_hours,
      equipment_id: orderData.equipment_id,
      lessee_company_id: orderData.company_id
    })
  });

  const result = await response.json();
  
  if (result.success) {
    return result.result.final_price;
  } else {
    throw new Error(result.error.message);
  }
}
Синхронизация наценок
python
import requests
import json

class MarkupSync:
    def __init__(self, base_url, api_token):
        self.base_url = base_url
        self.headers = {
            'Authorization': f'Bearer {api_token}',
            'Content-Type': 'application/json'
        }
    
    def get_active_markups(self):
        response = requests.get(
            f'{self.base_url}/api/v1/markups',
            params={'is_active': True},
            headers=self.headers
        )
        return response.json()
    
    def create_markup(self, markup_data):
        response = requests.post(
            f'{self.base_url}/api/v1/markups',
            json=markup_data,
            headers=self.headers
        )
        return response.json()
Мониторинг эффективности
php
<?php

class MarkupAnalytics {
    private $apiClient;
    
    public function __construct($apiClient) {
        $this->apiClient = $apiClient;
    }
    
    public function getDailyReport($date) {
        $response = $this->apiClient->get('/markups/statistics', [
            'period' => 'custom',
            'date_from' => $date,
            'date_to' => $date
        ]);
        
        $data = json_decode($response->getBody(), true);
        
        return [
            'applications' => $data['metrics']['total_applications'],
            'revenue' => $data['metrics']['total_revenue'],
            'top_markup' => $data['top_markups'][0] ?? null
        ];
    }
}

Миграция и версионирование
Версия API
Текущая версия: v1

Миграционные сценарии
При обновлении API:

Старые endpoints поддерживаются 6 месяцев

Уведомления о deprecated endpoints отправляются за 3 месяца

Подробная документация по миграции предоставляется

Обратная совместимость
Добавление новых полей не ломает обратную совместимость

Удаление полей происходит с уведомлением за 3 месяца

Новые обязательные поля вводятся постепенно
