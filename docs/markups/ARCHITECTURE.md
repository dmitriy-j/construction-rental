# Архитектура системы наценок платформы

## Обзор системы

Система наценок платформы представляет собой гибкий механизм применения дополнительных сборов к различным типам транзакций. Система поддерживает полиморфные связи, приоритеты применения и расширенный аудит изменений.

## Ключевые компоненты

### Модели данных

#### PlatformMarkup
Основная модель наценок с полиморфными связями:

```php
PlatformMarkup {
    id
    platform_id
    markupable_type    // Полиморфный тип: Equipment, Category, Company, null
    markupable_id      // ID сущности
    entity_type        // Контекст: order, rental_request, proposal
    type              // Тип наценки: fixed, percent, tiered, combined, seasonal
    calculation_type  // Метод расчета: addition, multiplication, complex
    value             // Значение наценки
    priority          // Приоритет (0-999)
    rules             // Дополнительные правила (JSON)
    is_active         // Статус активности
    valid_from        // Начало действия
    valid_to          // Окончание действия
}


PlatformMarkupAudit
Система аудита всех изменений:

php
PlatformMarkupAudit {
    id
    platform_markup_id
    user_id
    action            // created, updated, deleted
    old_values        // JSON
    new_values        // JSON
    reason           // Причина изменения
}
Сервисы расчета
MarkupCalculationService
Универсальный сервис расчета наценок:

php
class MarkupCalculationService {
    public function calculateMarkup(
        float $basePrice,
        string $entityType,
        int $workingHours = 1,
        ?int $equipmentId = null,
        ?int $categoryId = null,
        ?int $companyId = null,
        ?int $lesseeCompanyId = null
    ): array
}
Интегрированные сервисы
PricingService - расчет цен для заказов

RentalRequestPricingService - ценообразование заявок

PublicPricingService - публичное ценообразование

Принципы работы
Приоритетная система
Наценки применяются по приоритету (от высшего к низшему):

Оборудование (300-399) - конкретная техника

Категория (200-299) - категория оборудования

Компания (100-199) - компания арендатора

Общая наценка (0-99) - системная наценка

Процесс расчета
Поиск наценки по контексту и приоритету

Валидация активности и периода действия

Применение правил в зависимости от типа наценки

Кэширование результата для производительности

Аудит операции расчета

Типы наценок
Фиксированная (fixed)
Добавляет фиксированную сумму за час работы

Пример: 100 ₽/час × 8 часов = 800 ₽

Процентная (percent)
Добавляет процент от базовой цены

Пример: 10% от 1000 ₽ = 100 ₽

Ступенчатая (tiered)
Разные значения в зависимости от объема/срока

Пример:

0-100 часов: 50 ₽/час

101-200 часов: 40 ₽/час

Комбинированная (combined)
Сочетание фиксированной и процентной частей

Пример: 50 ₽/час + 5% от цены

Сезонная (seasonal)
Коэффициенты в зависимости от сезона

Пример: высокий сезон ×1.5, низкий сезон ×0.7

Интеграция с системой
Контексты применения
Заказы (order)
Применяется к финальным заказам аренды

Учитывает рабочее время и условия аренды

Заявки на аренду (rental_request)
Расчет для предложений арендодателей

Обратное применение наценки

Предложения (proposal)
Ценообразование коммерческих предложений

Специальные условия для переговоров

API endpoints
text
GET    /admin/markups                    # Список наценок
POST   /admin/markups                    # Создание наценки
PUT    /admin/markups/{id}              # Обновление наценки
DELETE /admin/markups/{id}              # Удаление наценки
POST   /admin/markups/test-calculation  # Тестирование расчета
GET    /admin/markups/statistics        # Статистика
POST   /admin/markups/bulk-operations   # Массовые операции
Безопасность и доступ
Ролевая модель
Администраторы - полный доступ

Менеджеры - просмотр и ограниченное редактирование

Аналитики - только просмотр статистики

Валидация данных
Проверка бизнес-правил

Валидация периодов действия

Контроль приоритетов

Проверка уникальности

Производительность
Кэширование
Результаты расчета наценок

Списки активных наценок

Статистические данные

Индексация
sql
INDEX (priority, is_active)
INDEX (entity_type, priority)  
INDEX (markupable_type, markupable_id, priority)
INDEX (valid_from, valid_to)
Оптимизации
Пакетная обработка массовых операций

Фоновые задачи для тяжелых расчетов

Инкрементальное обновление статистики

Мониторинг и аналитика
Метрики
Количество применений наценок

Общий доход от наценок

Эффективность по типам и контекстам

Время выполнения расчетов

Аудит
Полная история изменений

Отслеживание пользовательских действий

Экспорт данных для анализа

Расширяемость
Добавление новых типов наценок
Регистрация типа в MarkupCalculationService

Добавление правил валидации

Создание UI компонентов

Обновление документации

Интеграция с внешними системами
Webhooks для уведомлений

REST API для управления

Экспорт данных в форматах CSV/JSON

text


