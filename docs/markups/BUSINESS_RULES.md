# Бизнес-правила и кейсы системы наценок

## Общие принципы

### Приоритетная система

**Правило 1:** Наценки применяются по убыванию приоритета
Оборудование (300-399) → Категория (200-299) → Компания (100-199) → Общая (0-99)

text

**Правило 2:** При равном приоритете применяется наценка, созданная позже

**Правило 3:** Только одна наценка применяется к одному расчету

### Валидация данных

**Правило 4:** Значение наценки должно быть неотрицательным
```php
$value >= 0
Правило 5: Приоритет должен быть в диапазоне 0-999

php
$priority >= 0 && $priority <= 999
Правило 6: Период действия должен быть валидным

php
$valid_from <= $valid_to (если оба указаны)
Типы наценок
Фиксированная наценка
Формула расчета:

text
Наценка = Значение × Рабочие_часы
Бизнес-кейсы:

Кейс 1: Базовая эксплуатационная надбавка

json
{
  "type": "fixed",
  "value": 100,
  "entity_type": "order",
  "priority": 50
}
*Применение: 8 часов × 100 ₽/час = 800 ₽*

Кейс 2: Срочная аренда

json
{
  "type": "fixed", 
  "value": 500,
  "entity_type": "rental_request",
  "priority": 300,
  "markupable_type": "Equipment",
  "markupable_id": 123
}
Для конкретного оборудования при срочной аренде

Процентная наценка
Формула расчета:

text
Наценка = Базовая_цена × (Значение / 100)
Бизнес-кейсы:

Кейс 3: Стандартная комиссия платформы

json
{
  "type": "percent",
  "value": 10,
  "entity_type": "order", 
  "priority": 0
}
*Базовая цена 1000 ₽ × 10% = 100 ₽*

Кейс 4: Премиум-оборудование

json
{
  "type": "percent",
  "value": 15,
  "entity_type": "proposal",
  "priority": 350,
  "markupable_type": "Equipment", 
  "markupable_id": 456
}
Для премиального оборудования увеличенная комиссия

Ступенчатая наценка
Формула расчета:

text
Для каждой ступени:
  Если Рабочие_часы в диапазоне [min, max]:
    Если тип = fixed: Наценка = Значение × Рабочие_часы
    Если тип = percent: Наценка = Базовая_цена × (Значение / 100)
Бизнес-кейсы:

Кейс 5: Скидка за объем

json
{
  "type": "tiered",
  "value": 50,
  "rules": {
    "tiers": [
      {"min": 0, "max": 100, "type": "fixed", "value": 50},
      {"min": 101, "max": 200, "type": "fixed", "value": 40},
      {"min": 201, "max": 9999, "type": "percent", "value": 5}
    ]
  },
  "entity_type": "order",
  "priority": 100
}
Снижение наценки при долгосрочной аренде

Кейс 6: Прогрессивная комиссия

json
{
  "type": "tiered",
  "value": 10,
  "rules": {
    "tiers": [
      {"min": 0, "max": 50, "type": "percent", "value": 8},
      {"min": 51, "max": 100, "type": "percent", "value": 10},
      {"min": 101, "max": 9999, "type": "percent", "value": 12}
    ]
  },
  "entity_type": "order",
  "priority": 50
}
Увеличение комиссии для крупных заказов

Комбинированная наценка
Формула расчета:

text
Наценка = (Фиксированная_часть × Рабочие_часы) + (Базовая_цена × Процентная_часть / 100)
Бизнес-кейсы:

Кейс 7: Смешанная модель комиссии

json
{
  "type": "combined", 
  "value": 0,
  "rules": {
    "fixed_value": 50,
    "percent_value": 5
  },
  "entity_type": "order",
  "priority": 75
}
*50 ₽/час + 5% от стоимости = 50×8 + 1000×0.05 = 400 + 50 = 450 ₽*

Сезонная наценка
Формула расчета:

text
Наценка = Базовая_цена × (Базовый_процент / 100) × Коэффициент_сезона
Бизнес-кейсы:

Кейс 8: Сезонное ценообразование

json
{
  "type": "seasonal",
  "value": 10,
  "rules": {
    "high_season_coefficient": 1.5,
    "medium_season_coefficient": 1.0, 
    "low_season_coefficient": 0.7
  },
  "entity_type": "order",
  "priority": 60
}
*Летом: 1000 ₽ × 10% × 1.5 = 150 ₽*
*Зимой: 1000 ₽ × 10% × 0.7 = 70 ₽*

Контексты применения
Заказы (order)
Правило 7: Учитывается фактическое рабочее время

php
$workingHours = $rentalPeriod->getWorkingHours();
Правило 8: Применяется к финальной стоимости заказа

Бизнес-кейсы:

Кейс 9: Стандартный заказ аренды

Базовая цена: 1500 ₽/час

Рабочие часы: 8

Наценка: фиксированная 100 ₽/час

Итог: (1500 × 8) + (100 × 8) = 12,000 + 800 = 12,800 ₽

Заявки на аренду (rental_request)
Правило 9: Используется обратное применение наценки

php
$lessorPrice = $customerPrice - $markupAmount;
Правило 10: Учитывается бюджет арендатора

Бизнес-кейсы:

Кейс 10: Расчет цены для арендодателя

Бюджет арендатора: 1200 ₽/час

Наценка: процентная 10%

Цена для арендодателя: 1200 / 1.10 = 1090 ₽/час

Предложения (proposal)
Правило 11: Учитываются коммерческие условия

Правило 12: Возможность специальных коэффициентов

Бизнес-кейсы:

Кейс 11: Коммерческое предложение

Базовая цена: 2000 ₽/час

Специальная наценка: 8% (вместо стандартных 10%)

Итоговая цена: 2000 × 1.08 = 2160 ₽/час

Правила приоритетов
Группы приоритетов
Правило 13: Стандартные диапазоны приоритетов

text
0-99    Общие наценки
100-199 Наценки компаний  
200-299 Наценки категорий
300-399 Наценки оборудования
Правило 14: Рекомендуемые значения внутри групп

php
// Общие наценки
const PRIORITY_DEFAULT = 0;
const PRIORITY_STANDARD = 50;
const PRIORITY_HIGH = 99;

// Наценки компаний  
const PRIORITY_COMPANY_BASIC = 100;
const PRIORITY_COMPANY_VIP = 150;
const PRIORITY_COMPANY_PREMIUM = 199;

// Наценки категорий
const PRIORITY_CATEGORY_STANDARD = 200;
const PRIORITY_CATEGORY_SPECIAL = 250;

// Наценки оборудования
const PRIORITY_EQUIPMENT_BASIC = 300;
const PRIORITY_EQUIPMENT_PREMIUM = 350;
Конфликтные ситуации
Правило 15: Разрешение конфликтов при равном приоритете

Применяется наценка с более поздней датой создания

Логируется предупреждение о конфликте

Правило 16: Минимальный разрыв между приоритетами

php
$minGap = 5; // Рекомендуемый минимальный разрыв
Периоды действия
Валидация периодов
Правило 17: Проверка корректности периода

php
if ($validFrom && $validTo && $validFrom > $validTo) {
    throw new InvalidPeriodException();
}
Правило 18: Бессрочные наценки

php
// Оба поля null - наценка действует постоянно
$isPermanent = is_null($validFrom) && is_null($validTo);
Автоматическое управление
Правило 19: Автоматическая деактивация истекших наценок

php
// Ежедневная задача проверяет и деактивирует истекшие наценки
if ($markup->valid_to && $markup->valid_to < now()) {
    $markup->update(['is_active' => false]);
}
Правило 20: Уведомления о скором истечении

php
// За 7 дней до истечения отправляется уведомление
$expirationWarningDate = $markup->valid_to->subDays(7);
if (now() >= $expirationWarningDate) {
    $this->sendExpirationWarning($markup);
}
Бизнес-ограничения
Ограничения значений
Правило 21: Максимальное значение процентной наценки

php
const MAX_PERCENT_MARKUP = 50; // 50%
if ($type === 'percent' && $value > self::MAX_PERCENT_MARKUP) {
    throw new MarkupLimitExceededException();
}
Правило 22: Максимальное значение фиксированной наценки

php
const MAX_FIXED_MARKUP = 1000; // 1000 ₽/час
if ($type === 'fixed' && $value > self::MAX_FIXED_MARKUP) {
    throw new MarkupLimitExceededException();
}
Ограничения количества
Правило 23: Максимальное количество активных наценок

php
const MAX_ACTIVE_MARKUPS = 1000;
if (PlatformMarkup::active()->count() >= self::MAX_ACTIVE_MARKUPS) {
    throw new TooManyActiveMarkupsException();
}
Правило 24: Ограничение наценок на оборудование

php
const MAX_EQUIPMENT_MARKUPS = 5; // Максимум 5 наценок на оборудование
Аудит и соответствие
Требования к аудиту
Правило 25: Обязательное логирование всех изменений

php
// При любом изменении наценки создается запись аудита
$markup->logAudit('updated', $oldValues, $newValues, $reason);
Правило 26: Минимальная длина причины изменения

php
$minReasonLength = 10;
if (strlen($reason) < $minReasonLength) {
    throw new InvalidReasonException();
}
Соответствие требованиям
Правило 27: Сохранение истории ценовых изменений

php
// Все изменения ценовых параметров сохраняются на 5 лет
const AUDIT_RETENTION_YEARS = 5;
Правило 28: Возможность отката изменений

php
// Система позволяет восстановить предыдущую версию наценки
public function restoreFromAudit($auditId) {
    $audit = PlatformMarkupAudit::find($auditId);
    $this->update($audit->old_values);
}
Сценарии использования
Сценарий 1: Запуск новой платформы
Создание базовых наценок

Общая процентная наценка: 10% (приоритет 0)

Общая фиксированная наценка: 100 ₽/час (приоритет 50)

Настройка для партнеров

Для VIP-компаний: 8% (приоритет 150)

Для премиум-категорий: 12% (приоритет 250)

Специальные условия

Для конкретного оборудования: 150 ₽/час (приоритет 350)

Сценарий 2: Сезонное ценообразование
Подготовка к высокому сезону

Активация сезонных коэффициентов

Настройка повышенных ставок для премиум-оборудования

Низкий сезон

Применение понижающих коэффициентов

Специальные акции для постоянных клиентов

Сценарий 3: Массовые изменения
Повышение ставок

Выбор всех активных наценок

Увеличение значений на 5%

Предпросмотр изменений

Применение с указанием причины

Корректировка приоритетов

Группировка по типам сущностей

Установка стандартных приоритетов

Проверка конфликтов

Сценарий 4: Анализ эффективности
Еженедельный отчет

Анализ топ-10 наценок по доходу

Выявление неэффективных правил

Мониторинг сезонных трендов

Оптимизация правил

Деактивация редко используемых наценок

Корректировка значений на основе статистики

Тестирование новых подходов

Обработка исключительных ситуаций
Ошибки расчета
Ситуация 1: Не найдена подходящая наценка

Действие: Применяется наценка по умолчанию (100 ₽/час)

Логирование: Запись в лог с деталями контекста

Ситуация 2: Конфликт приоритетов

Действие: Применяется наценка с более поздней датой создания

Уведомление: Отправляется предупреждение администратору

Ситуация 3: Некорректные входные данные

Действие: Возвращается ошибка валидации

Рекомендация: Использовать тестовый калькулятор

Системные сбои
Ситуация 4: Недоступность сервиса расчета

Действие: Использование закэшированных значений

Резервный вариант: Фиксированная наценка 100 ₽/час

Ситуация 5: Перегрузка системы

Действие: Включение режима ограничения запросов

Приоритет: Обслуживание критических операций

Миграция и обновления
Миграция правил
Процедура 1: Перенос устаревших форматов

Конвертация старых типов наценок

Сохранение истории изменений

Валидация новых правил

Процедура 2: Обновление бизнес-логики

Поэтапное внедрение изменений

A/B тестирование новых подходов

Откат при обнаружении проблем

Обеспечение обратной совместимости
Принцип: Старые API endpoints поддерживаются 6 месяцев
Уведомление: За 3 месяца до отключения устаревших функций
Миграция: Предоставление инструментов для автоматического переноса

