<?php

use App\Http\Controllers\DeliveryController;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\API\LocationController;
use App\Http\Controllers\API\PublicProposalController;
use App\Http\Controllers\API\PublicRentalRequestController;
use App\Http\Controllers\API\LessorProposalTemplateController;
use App\Http\Controllers\API\ProposalCartController;
use App\Http\Controllers\API\LessorDashboardController; // üî• –î–û–ë–ê–í–õ–ï–ù–û
use App\Http\Controllers\API\LessorRecommendationController;

Route::middleware('auth:sanctum')->get('/user', function (Request $request) {
    return $request->user()->load('company');
});

// –ü—É–±–ª–∏—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
Route::prefix('public')->group(function () {
    Route::get('/rental-requests', [PublicRentalRequestController::class, 'index'])
        ->name('api.public.rental-requests.index');

    Route::get('/rental-requests/{id}', [PublicRentalRequestController::class, 'show'])
        ->name('api.public.rental-requests.show');
});

// –î–æ—Å—Ç–∞–≤–∫–∞
Route::prefix('delivery')->group(function () {
    Route::post('/calculate', [DeliveryController::class, 'calculate']);
    Route::get('/locations', [DeliveryController::class, 'getLocations']);
});

// –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
Route::get('/rental-requests/{rentalRequest}/available-equipment', [PublicProposalController::class, 'getAvailableEquipment'])
    ->middleware(['auth:sanctum', 'company.verified'])
    ->name('api.public.rental-requests.available-equipment');

Route::post('/rental-requests/{rentalRequest}/proposals', [PublicProposalController::class, 'store'])
    ->middleware(['auth:sanctum', 'company.verified'])
    ->name('api.public.rental-requests.proposals.store');

// –ú–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–æ–≤
Route::middleware(['auth:sanctum'])->prefix('lessee')->group(function () {
    Route::get('/rental-requests', [\App\Http\Controllers\API\RentalRequestController::class, 'index']);
    Route::get('/rental-requests/{id}', [\App\Http\Controllers\API\RentalRequestController::class, 'show']);
    Route::post('/rental-requests', [\App\Http\Controllers\API\RentalRequestController::class, 'store']);
    Route::get('/rental-requests/{id}/show', [\App\Http\Controllers\API\RentalRequestController::class, 'showForVue']);
    Route::put('/rental-requests/{id}', [\App\Http\Controllers\API\RentalRequestController::class, 'update']);

    Route::get('/categories/{categoryId}/specifications',
        [\App\Http\Controllers\API\SpecificationController::class, 'getTemplate']);
    Route::post('/specifications/validate',
        [\App\Http\Controllers\API\SpecificationController::class, 'validateSpecifications']);

    Route::post('/rental-requests/{id}/pause', [\App\Http\Controllers\API\RentalRequestController::class, 'pause']);
    Route::post('/rental-requests/{id}/resume', [\App\Http\Controllers\API\RentalRequestController::class, 'resume']);
    Route::post('/rental-requests/{id}/cancel', [\App\Http\Controllers\API\RentalRequestController::class, 'cancel']);
    Route::post('/rental-requests/{request}/proposals/{proposal}/accept', [\App\Http\Controllers\API\RentalRequestController::class, 'acceptProposal']);
    Route::post('/rental-requests/{request}/proposals/{proposal}/reject', [\App\Http\Controllers\API\RentalRequestController::class, 'rejectProposal']);
    Route::get('/rental-requests/stats', [\App\Http\Controllers\API\RentalRequestController::class, 'stats']);
});

// –ü—É–±–ª–∏—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
Route::prefix('public')->group(function () {
    Route::get('/rental-requests', [PublicRentalRequestController::class, 'index']);
    Route::get('/rental-requests/{id}', [PublicRentalRequestController::class, 'show']);
});

// –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª–µ–π
Route::middleware(['auth:sanctum', 'company.verified'])->group(function () {
    Route::get('/rental-requests/{rentalRequest}/available-equipment',
        [PublicProposalController::class, 'getAvailableEquipment'])
        ->name('api.public.rental-requests.available-equipment');

    Route::post('/rental-requests/{rentalRequest}/proposals',
        [PublicProposalController::class, 'store'])
        ->name('api.public.rental-requests.proposals.store');

    Route::get('/proposals/{proposal}/bulk',
        [PublicProposalController::class, 'getBulkProposal'])
        ->name('api.public.proposals.bulk');

    Route::post('/proposals/{proposal}/accept-bulk',
        [PublicProposalController::class, 'acceptBulkProposal'])
        ->name('api.public.proposals.accept-bulk');

    Route::post('/lessor/equipment/available-for-request',
        [\App\Http\Controllers\API\LessorEquipmentController::class, 'getAvailableForRequest']);
});

// üî• –û–°–ù–û–í–ù–´–ï –ú–ê–†–®–†–£–¢–´ –î–õ–Ø –ê–†–ï–ù–î–û–î–ê–¢–ï–õ–ï–ô
Route::middleware(['auth:sanctum', 'company.lessor'])->prefix('lessor')->group(function () {
    // –ó–∞—è–≤–∫–∏ –Ω–∞ –∞—Ä–µ–Ω–¥—É
    Route::get('/rental-requests', [\App\Http\Controllers\API\LessorRentalRequestController::class, 'index']);
    Route::get('/rental-requests/{id}', [\App\Http\Controllers\API\LessorRentalRequestController::class, 'show']);
    Route::get('/rental-requests/{id}/analytics', [\App\Http\Controllers\API\LessorRentalRequestController::class, 'analytics']);

    // –®–∞–±–ª–æ–Ω—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
    Route::apiResource('proposal-templates', LessorProposalTemplateController::class);
    Route::get('proposal-templates/stats', [LessorProposalTemplateController::class, 'stats']);
    Route::post('proposal-templates/bulk-actions', [LessorProposalTemplateController::class, 'bulkActions']);

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ –∫ –∑–∞—è–≤–∫–∞–º
    Route::post('proposal-templates/{templateId}/preview-apply/{rentalRequestId}', [LessorProposalTemplateController::class, 'previewApplyTemplate']);
    Route::post('proposal-templates/{templateId}/apply/{rentalRequestId}', [LessorProposalTemplateController::class, 'applyTemplate']);
    Route::post('rental-requests/{rentalRequest}/apply-template/{template}', [LessorProposalTemplateController::class, 'applyToRequest']);

    // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    Route::get('/proposals', [\App\Http\Controllers\API\LessorProposalController::class, 'index']);

    // üî• –ú–ê–†–®–†–£–¢ –î–õ–Ø –°–ß–ï–¢–ß–ò–ö–û–í –î–ê–®–ë–û–†–î–ê - –î–û–ë–ê–í–õ–ï–ù–û
    Route::get('/dashboard-counters', [LessorDashboardController::class, 'getCounters'])
        ->name('lessor.dashboard-counters');

     Route::get('/proposal-templates/{id}/ab-test-stats', [LessorProposalTemplateController::class, 'getAbTestStats']);
    Route::post('/proposal-templates/{id}/start-ab-test', [LessorProposalTemplateController::class, 'startAbTest']);
    Route::post('/proposal-templates/{id}/stop-ab-test', [LessorProposalTemplateController::class, 'stopAbTest']);
    Route::post('/proposal-templates/{id}/declare-winner', [LessorProposalTemplateController::class, 'declareWinner']);

    // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    Route::get('/rental-requests/{rentalRequestId}/recommendations',
        [LessorRecommendationController::class, 'getRecommendations']);
    Route::post('/recommendations/quick',
        [LessorRecommendationController::class, 'getQuickRecommendations']);
    Route::post('/recommendation-feedback',
        [LessorRecommendationController::class, 'saveFeedback']);
    Route::get('/recommendations/stats',
        [LessorRecommendationController::class, 'getStats']);
});

// –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–ª—è –∞—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—è
Route::prefix('lessor/analytics')->group(function () {
    Route::get('/realtime', [\App\Http\Controllers\API\LessorAnalyticsController::class, 'getRealTimeData']);
    Route::get('/strategic', [\App\Http\Controllers\API\LessorAnalyticsController::class, 'getStrategicData']);
    Route::get('/dashboard-counters', [\App\Http\Controllers\API\LessorAnalyticsController::class, 'getDashboardCounters']);
});

// –ö–æ—Ä–∑–∏–Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
Route::middleware(['auth:sanctum'])->group(function () {
    Route::prefix('cart')->group(function () {
        Route::get('/proposal', [ProposalCartController::class, 'getProposalCart']);
        Route::post('/proposal/add', [ProposalCartController::class, 'addToCart']);
        Route::post('/proposal/extend-reservation', [ProposalCartController::class, 'extendReservation']);
        Route::get('/request-progress/{requestId}', [ProposalCartController::class, 'getRequestProgress']);
        Route::delete('/items/{itemId}', [ProposalCartController::class, 'removeItem']);
        Route::post('/remove-selected', [ProposalCartController::class, 'removeSelected']);
        Route::post('/proposal/checkout-selected', [ProposalCartController::class, 'checkoutSelected']);
        Route::post('/proposal/direct-checkout-selected', [ProposalCartController::class, 'directCheckoutSelected']);
        Route::post('/proposal/simple-checkout-selected', [ProposalCartController::class, 'simpleCheckoutSelected']);
        Route::delete('/remove-selected-items', [ProposalCartController::class, 'removeSelectedItems']);
        Route::post('proposal/update-rental-period', [ProposalCartController::class, 'updateRentalPeriod']);
        Route::post('proposal/test-api', [ProposalCartController::class, 'testApi']);
    });
});

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
Route::post('/rental-requests/{id}/calculate-delivery', [PublicProposalController::class, 'calculateDelivery'])
    ->middleware(['auth:sanctum', 'company.verified']);
Route::post('/proposal-cart/checkout', [ProposalCartController::class, 'checkoutSelected'])
    ->middleware(['auth:sanctum']);

// üî• –î–ï–ë–ê–ì –ú–ê–†–®–†–£–¢–´
Route::get('/debug/edit-test/{id}', function ($id) {
    \Log::info('API Debug Test', ['id' => $id, 'user' => auth()->user()]);

    return response()->json([
        'success' => true,
        'message' => 'API —Ç–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω',
        'data' => [
            'request_id' => $id,
            'user_id' => auth()->id(),
            'user_email' => auth()->user()->email,
            'timestamp' => now()
        ]
    ]);
})->middleware('auth:sanctum');

Route::middleware(['auth:sanctum'])->prefix('lessee')->group(function () {
    Route::get('/debug/edit-test/{id}', function ($id) {
        \Log::info('API Debug Test', [
            'id' => $id,
            'user_id' => auth()->id(),
            'user_email' => auth()->user()->email
        ]);

        return response()->json([
            'success' => true,
            'message' => 'API —Ç–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω',
            'data' => [
                'request_id' => $id,
                'user_id' => auth()->id(),
                'user_email' => auth()->user()->email,
                'timestamp' => now()->toDateTimeString()
            ]
        ]);
    });
});
